<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName my-pricer-api.gillesstenger.fr

        # Preserve the original Host header from the client
        ProxyPreserveHost On

        # --- WebSocket Proxy Configuration ---
        # This section is CRUCIAL for Flask-SocketIO WebSockets.
        # It detects WebSocket upgrade requests and proxies them using the ws:// protocol.
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        # Proxy WebSocket requests to the backend's Socket.IO endpoint
        # Assuming your Flask backend listens on 127.0.0.1:5001 (HTTP)
        RewriteRule /(.*) ws://127.0.0.1:5001/$1 [P,L]
        # --- End WebSocket Proxy Configuration ---

        # Standard HTTP/HTTPS proxy for all other API routes.
        # This must come AFTER the RewriteRule for WebSockets to ensure WebSockets are handled first.
        # Assuming your Flask backend listens on 127.0.0.1:5001 (HTTP)
        ProxyPass / http://127.0.0.1:5001/
        ProxyPassReverse / http://127.0.0.1:5001/

        # Error and Access Log files for this Virtual Host
        ErrorLog ${APACHE_LOG_DIR}/my-pricer-api_error.log
        CustomLog ${APACHE_LOG_DIR}/my-pricer-api_access.log combined

        # Include SSL configuration from Let's Encrypt
        Include /etc/letsencrypt/options-ssl-apache.conf
        SSLCertificateFile /etc/letsencrypt/live/my-pricer-api.gillesstenger.fr/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/my-pricer-api.gillesstenger.fr/privkey.pem
    </VirtualHost>
</IfModule>